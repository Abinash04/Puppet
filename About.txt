Overview/Description
Puppet is an open source configuration management tool. Puppet is closely coupled with the DevOps methodology and is implemented with its own declarative language (or Ruby). Mostly used by system administrators, Puppet automates the configuration, provisioning and management of physical and virtual servers. With automation, Puppet eliminates the errors that occur with manual tasks.

CONFIGURATION MANAGEMENT TOOLS:
1. CFEngine
2. Ansible
3. Puppet
4. Chef


To know the version of puppet installed:

abinash@ubuntu:~$ puppet --version
4.8.2

INSTALLATION:


1. delete firewall rules:
iptables -F

2. save firewall
/sbin/iptables-save

[ec2-user@ip-172-31-34-41 ~]$ sudo iptables -F
[ec2-user@ip-172-31-34-41 ~]$ sudo /sbin/iptables-save
# Generated by iptables-save v1.4.21 on Sat Dec 23 22:52:47 2017
*filter
:INPUT ACCEPT [38:2864]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [22:2336]
COMMIT
# Completed on Sat Dec 23 22:52:47 2017
[ec2-user@ip-172-31-34-41 ~]$




3. install puppet
To install Puppet, in a terminal on the server enter:

sudo apt install puppetmaster
	On the client machine, or machines, enter:

sudo apt install puppet

3. 

sudo vi /etc/hosts
192.168.174.133 puppet puppetmaster

4.

[main]
ssldir = /var/lib/puppet/ssl

[master]
vardir = /var/lib/puppet
cadir  = /var/lib/puppet/ssl/ca
dns_alt_names = puppet
certname = puppet

5.
abinash@ubuntu:~$ sudo systemctl restart puppetmaster.service

PA
sudo /bin/systemctl start puppet.service

[ec2-user@ip-172-31-38-255 ~]$ sudo /bin/systemctl start puppet.service
[ec2-user@ip-172-31-38-255 ~]$ puppet --version
3.6.2
[ec2-user@ip-172-31-38-255 ~]$

6.

Updated:
  openssh-server.x86_64 0:7.4p1-13.el7_4

Dependency Updated:
  openssh.x86_64 0:7.4p1-13.el7_4                                                openssh-clients.x86_64 0:7.4p1-13.el7_4

Complete!
[ec2-user@ip-172-31-38-255 .ssh]$ sudo yum install openssh-server -y

PM:
[ec2-user@ip-172-31-34-41 ~]$ puppet resource service puppetmaster ensure=running
Error: Could not start Service[puppetmaster]: Execution of '/usr/bin/systemctl start puppetmaster' returned 1: Failed to start puppetmaster.service: Interactive authentication required.
See system logs and 'systemctl status puppetmaster.service' for details.
Wrapped exception:
Execution of '/usr/bin/systemctl start puppetmaster' returned 1: Failed to start puppetmaster.service: Interactive authentication required.
See system logs and 'systemctl status puppetmaster.service' for details.
Error: /Service[puppetmaster]/ensure: change from stopped to running failed: Could not start Service[puppetmaster]: Execution of '/usr/bin/systemctl start puppetmaster' returned 1: Failed to start puppetmaster.service: Interactive authentication required.
See system logs and 'systemctl status puppetmaster.service' for details.
service { 'puppetmaster':
  ensure => 'stopped',
}
[ec2-user@ip-172-31-34-41 ~]$

[ec2-user@ip-172-31-34-41 ~]$ sudo puppet resource service puppetmaster ensure=running
Error: Could not start Service[puppetmaster]: Execution of '/bin/systemctl start puppetmaster' returned 5: Failed to start puppetmaster.service: Unit not found.
Wrapped exception:
Execution of '/bin/systemctl start puppetmaster' returned 5: Failed to start puppetmaster.service: Unit not found.
Error: /Service[puppetmaster]/ensure: change from stopped to running failed: Could not start Service[puppetmaster]: Execution of '/bin/systemctl start puppetmaster' returned 5: Failed to start puppetmaster.service: Unit not found.
service { 'puppetmaster':
  ensure => 'stopped',
}
[ec2-user@ip-172-31-34-41 ~]$ sudo puppet resource service puppet ensure=running
Notice: /Service[puppet]/ensure: ensure changed 'stopped' to 'running'
service { 'puppet':
  ensure => 'running',
}
[ec2-user@ip-172-31-34-41 ~]$

PM:

[ec2-user@ip-172-31-34-41 ~]$ sudo service puppet status
Redirecting to /bin/systemctl status puppet.service
 puppet.service - Puppet agent
   Loaded: loaded (/usr/lib/systemd/system/puppet.service; enabled; vendor preset: disabled)
   Active: active (running) since Sat 2017-12-23 22:37:56 UTC; 16min ago
 Main PID: 1527 (puppet)
   CGroup: /system.slice/puppet.service
           +-1527 /usr/bin/ruby /usr/bin/puppet agent --no-daemonize

Dec 23 22:37:56 ip-172-31-34-41.ec2.internal systemd[1]: Starting Puppet agent...
Dec 23 22:37:57 ip-172-31-34-41.ec2.internal puppet-agent[1527]: Could not request certificate: Connection refused - connect(2)
Dec 23 22:39:57 ip-172-31-34-41.ec2.internal puppet-agent[1527]: Could not request certificate: Connection refused - connect(2)
Dec 23 22:41:57 ip-172-31-34-41.ec2.internal puppet-agent[1527]: Could not request certificate: Connection refused - connect(2)
Dec 23 22:43:57 ip-172-31-34-41.ec2.internal puppet-agent[1527]: Could not request certificate: Connection refused - connect(2)
Dec 23 22:45:57 ip-172-31-34-41.ec2.internal puppet-agent[1527]: Could not request certificate: Connection refused - connect(2)
Dec 23 22:47:57 ip-172-31-34-41.ec2.internal puppet-agent[1527]: Could not request certificate: Connection refused - connect(2)
Dec 23 22:49:57 ip-172-31-34-41.ec2.internal puppet-agent[1527]: Could not request certificate: Connection refused - connect(2)
Dec 23 22:51:57 ip-172-31-34-41.ec2.internal puppet-agent[1527]: Could not request certificate: Connection refused - connect(2)
Dec 23 22:53:57 ip-172-31-34-41.ec2.internal puppet-agent[1527]: Could not request certificate: Connection refused - connect(2)
[ec2-user@ip-172-31-34-41 ~]$ date
Sat Dec 23 22:54:29 UTC 2017


CONNECTING TWO EC2 INSTANCES:

PuppetAgent:
instance_id:
i-031cb5650a03f6658
private_ip:
172.31.38.255
security_grp_id:
sg-c2ee0fb6

________________________________________
PuppetrMaster:
instance_id:
i-0eb581ed3be40ff1d
private_ip:
172.31.34.41
security_grp_id:
sg-5123c225



[ec2-user@ip-172-31-34-41 ~]$ puppet help

Usage: puppet <subcommand> [options] <action> [options]

Available subcommands:

  agent             The puppet agent daemon
  apply             Apply Puppet manifests locally
  ca                Local Puppet Certificate Authority management.
  catalog           Compile, save, view, and convert catalogs.
  cert              Manage certificates and requests
  certificate       Provide access to the CA for certificate management.
  certificate_request  Manage certificate requests.
  certificate_revocation_list  Manage the list of revoked certificates.
  config            Interact with Puppet's settings.
  describe          Display help about resource types
  device            Manage remote network devices
  doc               Generate Puppet documentation and references
  facts             Retrieve and store facts.
  file              Retrieve and store files in a filebucket
  filebucket        Store and retrieve files in a filebucket
  help              Display Puppet help.
  inspect           Send an inspection report
  instrumentation_data  Manage instrumentation listener accumulated data.
  instrumentation_listener  Manage instrumentation listeners.
  instrumentation_probe  Manage instrumentation probes.
  key               Create, save, and remove certificate keys.
  kick              Remotely control puppet agent
  man               Display Puppet manual pages.
  master            The puppet master daemon
  module            Creates, installs and searches for modules on the Puppet Forge.
  node              View and manage node definitions.
  parser            Interact directly with the parser.
  plugin            Interact with the Puppet plugin system.
  queue             Deprecated queuing daemon for asynchronous storeconfigs
  report            Create, display, and submit reports.
  resource          The resource abstraction layer shell
  resource_type     View classes, defined resource types, and nodes from all manifests.
  secret_agent      Mimics puppet agent.
  status            View puppet server status.

See 'puppet help <subcommand> <action>' for help on a specific subcommand action.
See 'puppet help <subcommand>' for help on a specific subcommand.
Puppet v3.6.2
[ec2-user@ip-172-31-34-41 ~]$


[ec2-user@ip-172-31-34-41 ~]$ sudo -u puppet puppet master --no-daemonize --verbose
Notice: Starting Puppet master version 3.6.2
^CNotice: Caught INT; calling stop

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Step 1: Enable Dependencies and Puppet Labs Repository On Master

1. become root
2. rpm -ivh http://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm
[root@ip-172-31-40-1 ec2-user]# rpm -ivh http://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm
Retrieving http://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm
warning: /var/tmp/rpm-tmp.5tK01X: Header V4 RSA/SHA1 Signature, key ID ef8d349f: NOKEY
Preparing...                          ################################# [100%]
Updating / installing...
   1:puppetlabs-release-22.0-2        ################################# [100%]
[root@ip-172-31-40-1 ec2-user]#

Step 2: Installing and Upgrading Puppet on the Master Server

[root@ip-172-31-40-1 ec2-user]# yum install puppet-server

Installed:
  puppet-server.noarch 0:3.8.7-1.el7

Dependency Installed:
  augeas-libs.x86_64 0:1.4.0-2.el7_4.2        facter.x86_64 1:2.4.6-1.el7            hiera.noarch 0:1.3.4-1.el7             libselinux-ruby.x86_64 0:2.5-11.el7
  pciutils.x86_64 0:3.5.1-2.el7               puppet.noarch 0:3.8.7-1.el7            ruby.x86_64 0:2.0.0.648-30.el7         ruby-augeas.x86_64 0:0.5.0-1.el7
  ruby-irb.noarch 0:2.0.0.648-30.el7          ruby-libs.x86_64 0:2.0.0.648-30.el7    ruby-shadow.x86_64 1:2.2.0-2.el7       rubygem-bigdecimal.x86_64 0:1.2.0-30.el7
  rubygem-io-console.x86_64 0:0.4.2-30.el7    rubygem-json.x86_64 0:1.7.7-30.el7     rubygem-psych.x86_64 0:2.0.0-30.el7    rubygem-rdoc.noarch 0:4.0.0-30.el7
  rubygems.noarch 0:2.0.14.1-30.el7

Complete!


Next, run the following command to upgrade Puppet to most newest version.

[root@ip-172-31-40-1 ec2-user]# puppet resource package puppet-server ensure=latest

package { 'puppet-server':
  ensure => '3.8.7-1.el7',
}

Once upgrade process completes, you will need to restart the puppet master web server to reflect new changes.
[root@ip-172-31-40-1 ec2-user]#/bin/systemctl start puppetmaster.service

[root@ip-172-31-40-1 ec2-user]# ps -ef | grep puppet
puppet    1472     1 72 11:22 ?        00:00:34 /usr/bin/ruby /usr/bin/puppet master --no-daemonize

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

AGENT:

1. become root
2. Installing and Upgrading Puppet on the Agent Server
[root@ip-172-31-41-162 ec2-user]#  yum install puppet

Dependency Installed:
  augeas-libs.x86_64 0:1.4.0-2.el7_4.2        facter.x86_64 1:1.7.6-2.1.el7sat      hiera.noarch 0:1.3.1-2.el7             libselinux-ruby.x86_64 0:2.5-11.el7
  pciutils.x86_64 0:3.5.1-2.el7               ruby.x86_64 0:2.0.0.648-30.el7        ruby-augeas.x86_64 0:0.5.0-1.el7       ruby-irb.noarch 0:2.0.0.648-30.el7
  ruby-libs.x86_64 0:2.0.0.648-30.el7         ruby-rgen.noarch 0:0.6.5-2.el7sat     ruby-shadow.x86_64 0:1.4.1-21.el7      rubygem-bigdecimal.x86_64 0:1.2.0-30.el7
  rubygem-io-console.x86_64 0:0.4.2-30.el7    rubygem-json.x86_64 0:1.7.7-30.el7    rubygem-psych.x86_64 0:2.0.0-30.el7    rubygem-rdoc.noarch 0:4.0.0-30.el7
  rubygems.noarch 0:2.0.14.1-30.el7

Complete!

Now upgrade the installed puppet agent to the most recent versions, with the help of following command.

[root@ip-172-31-41-162 ec2-user]# puppet resource package puppet ensure=latest

[root@ip-172-31-41-162 ec2-user]# puppet resource package puppet ensure=latest
Warning: The package type's allow_virtual parameter will be changing its default value from false to true in a future release. If you do not want to allow virtual packages, please explicitly set allow_virtual to false.
   (at /usr/share/ruby/vendor_ruby/puppet/type.rb:816:in `set_default')
package { 'puppet':
  ensure => '3.6.2-1.el7sat',
}

Once upgrade process completes, you will need to restart the puppet agent server to reflect new changes.

[root@ip-172-31-41-162 ec2-user]# /bin/systemctl start puppet.service
[root@ip-172-31-41-162 ec2-user]# ps -ef | grep puppet
root      1419     1 93 11:36 ?        00:00:07 /usr/bin/ruby /usr/bin/puppet agent  --no-daemonize


+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Configure a Puppet Master Server
After installing Puppet on a node that will act as a puppet master server, you need to:

Get the master’s names and certificates set up
Configure any necessary settings
Put your Puppet modules and manifests in place
Configure a production-ready web server
Configure load balancing and CA service routing if you’re using multiple masters
Start the puppet master service

SETTING/CONFIGURATIONS:

SERVER:

[root@ip-172-31-40-1 ec2-user]# vi /etc/hosts
172.31.40.1 puppet puppet.master.com
[root@ip-172-31-40-1 ec2-user]# vi /etc/puppet/puppet.conf
[root@ip-172-31-40-1 ec2-user]#
[main]
    dns_alt_names = puppet,puppet.master.com,puppetserver
    certname = puppet

[root@ip-172-31-40-1 ec2-user]# /bin/systemctl restart puppetmaster.service
[root@ip-172-31-40-1 ec2-user]#

CERTIFICATE SIGNING:
stop the puppet
[root@ip-172-31-40-1 ec2-user]# /bin/systemctl stop puppetmaster.service

[root@ip-172-31-40-1 ec2-user]# sudo -u puppet puppet master --no-daemonize --verbose
Info: Creating a new SSL key for ca
Info: Creating a new SSL certificate request for ca
Info: Certificate Request fingerprint (SHA256): 51:35:49:94:15:AC:0F:31:5C:4E:3E:53:2F:C6:C5:88:E4:C0:C3:5E:CA:EE:C1:74:9C:F9:54:2F:00:84:B6:D6
Notice: Signed certificate request for ca
Info: Creating a new certificate revocation list
Info: Creating a new SSL key for ip-172-31-40-1.ec2.internal
Info: csr_attributes file loading from /var/lib/puppet/.puppet/csr_attributes.yaml
Info: Creating a new SSL certificate request for ip-172-31-40-1.ec2.internal
Info: Certificate Request fingerprint (SHA256): 89:B7:C4:6E:F6:D3:17:64:FA:B4:1F:86:F3:CF:A2:00:07:D2:21:C2:33:71:B2:A3:A6:6C:EE:50:68:CC:5D:13
Notice: ip-172-31-40-1.ec2.internal has a waiting certificate request
Notice: Signed certificate request for ip-172-31-40-1.ec2.internal
Notice: Removing file Puppet::SSL::CertificateRequest ip-172-31-40-1.ec2.internal at '/var/lib/puppet/.puppet/ssl/ca/requests/ip-172-31-40-1.ec2.internal.pem'
Notice: Removing file Puppet::SSL::CertificateRequest ip-172-31-40-1.ec2.internal at '/var/lib/puppet/.puppet/ssl/certificate_requests/ip-172-31-40-1.ec2.internal.pem'
Notice: Starting Puppet master version 3.8.7
^CNotice: Caught INT; exiting
[root@ip-172-31-40-1 ec2-user]#

[root@ip-172-31-40-1 ec2-user]# puppet resource service puppetmaster ensure=running
Notice: /Service[puppetmaster]/ensure: ensure changed 'stopped' to 'running'
service { 'puppetmaster':
  ensure => 'running',
}


[root@ip-172-31-40-1 ec2-user]# service puppetmaster status
Redirecting to /bin/systemctl status puppetmaster.service
? puppetmaster.service - Puppet master
   Loaded: loaded (/usr/lib/systemd/system/puppetmaster.service; disabled; vendor preset: disabled)
   Active: active (running) since Sun 2017-12-24 11:58:35 UTC; 35s ago
 Main PID: 8908 (puppet)
   CGroup: /system.slice/puppetmaster.service
           +-8908 /usr/bin/ruby /usr/bin/puppet master --no-daemonize

Dec 24 11:58:35 ip-172-31-40-1.ec2.internal systemd[1]: Started Puppet master.
Dec 24 11:58:35 ip-172-31-40-1.ec2.internal systemd[1]: Starting Puppet master...
Dec 24 11:58:51 ip-172-31-40-1.ec2.internal puppet[8908]: Notice: Starting Puppet master version 3.8.7
[root@ip-172-31-40-1 ec2-user]#



AGENT:

[root@ip-172-31-41-162 ec2-user]# vi /etc/hosts
172.31.41.162 puppetagent
172.31.40.1 puppet puppet.master.com

[root@ip-172-31-41-162 ec2-user]# vi /etc/puppet/puppet.conf
[agent]
    server = puppet.master.com

[root@ip-172-31-41-162 ec2-user]# /bin/systemctl restart puppet.service

CERTIFICATE SIGNING:
[root@ip-172-31-41-162 ec2-user]# /bin/systemctl stop puppet.service


[root@ip-172-31-41-162 ec2-user]# puppet agent -t
Error: Could not request certificate: execution expired
Exiting; failed to retrieve certificate and waitforcert is disabled
[root@ip-172-31-41-162 ec2-user]#

TRIED:
- setting up security group with ICMPv4 rule, didn't help.
- disabling firewalls (iptables -F; /sbin/iptables-save)
- tried restarting puppet services
- ssh keys exchanged,didnt work

[ec2-user@ip-172-31-41-162 etc]$ telnet puppet.master.com 8140
Trying 172.31.40.1...
Connected to puppet.master.com.
Escape character is '^]'.
^C


Solution:
- Add the certname = <cert_name> in the agent server.
- if you are workign on ec2 instance then enable TCP under security policy
(just enable the telnet)
-open the 8140 firewall port on the master server (iptables -I INPUT -m state --state NEW -m tcp -p tcp --dport 8140 -j ACCEPT)

AGENT:
^X^ZConnection closed by foreign host.
[ec2-user@ip-172-31-41-162 etc]$
[ec2-user@ip-172-31-41-162 etc]$
[ec2-user@ip-172-31-41-162 etc]$
[ec2-user@ip-172-31-41-162 etc]$
[ec2-user@ip-172-31-41-162 etc]$
[ec2-user@ip-172-31-41-162 etc]$ sudo puppet agent -t
Info: Caching certificate for ca
Info: csr_attributes file loading from /etc/puppet/csr_attributes.yaml
Info: Creating a new SSL certificate request for puppetclient
Info: Certificate Request fingerprint (SHA256): DE:3D:BE:6B:5E:65:DA:42:11:99:DB:30:6A:A1:55:11:77:67:63:8F:06:E4:8B:27:97:DE:56:3A:4D:1A:3D:E2
Info: Caching certificate for ca
Exiting; no certificate found and waitforcert is disabled
[ec2-user@ip-172-31-41-162 etc]$

SERVER:
[ec2-user@ip-172-31-40-1 ~]$ sudo puppet cert list
  "puppetclient" (SHA256) DE:3D:BE:6B:5E:65:DA:42:11:99:DB:30:6A:A1:55:11:77:67:63:8F:06:E4:8B:27:97:DE:56:3A:4D:1A:3D:E2
[ec2-user@ip-172-31-40-1 ~]$

[ec2-user@ip-172-31-40-1 ~]$ sudo puppet cert sign puppetclient
Notice: Signed certificate request for puppetclient
Notice: Removing file Puppet::SSL::CertificateRequest puppetclient at '/var/lib/puppet/ssl/ca/requests/puppetclient.pem'
[ec2-user@ip-172-31-40-1 ~]$


AGENT:

[ec2-user@ip-172-31-41-162 etc]$ sudo puppet resource service puppet ensure=running
service { 'puppet':
  ensure => 'running',
}
[ec2-user@ip-172-31-41-162 etc]$ sudo service puppet status
Redirecting to /bin/systemctl status puppet.service
? puppet.service - Puppet agent
   Loaded: loaded (/usr/lib/systemd/system/puppet.service; disabled; vendor preset: disabled)
   Active: active (running) since Mon 2017-12-25 13:38:33 UTC; 23min ago
 Main PID: 1715 (puppet)
   CGroup: /system.slice/puppet.service
           +-1715 /usr/bin/ruby /usr/bin/puppet agent --no-daemonize

Dec 25 13:38:33 ip-172-31-41-162.ec2.internal systemd[1]: Started Puppet agent.
Dec 25 13:38:33 ip-172-31-41-162.ec2.internal systemd[1]: Starting Puppet agent...
Dec 25 13:40:33 ip-172-31-41-162.ec2.internal puppet-agent[1715]: Could not request certificate: execution expired
Dec 25 13:44:33 ip-172-31-41-162.ec2.internal puppet-agent[1715]: Could not request certificate: execution expired
Dec 25 13:48:33 ip-172-31-41-162.ec2.internal puppet-agent[1715]: Could not request certificate: execution expired
Dec 25 13:52:34 ip-172-31-41-162.ec2.internal puppet-agent[1715]: Could not request certificate: execution expired
Dec 25 13:56:34 ip-172-31-41-162.ec2.internal puppet-agent[1715]: Could not request certificate: execution expired
Dec 25 14:00:34 ip-172-31-41-162.ec2.internal puppet-agent[1715]: Starting Puppet client version 3.6.2
Dec 25 14:00:34 ip-172-31-41-162.ec2.internal puppet-agent[1813]: Finished catalog run in 0.01 seconds
[ec2-user@ip-172-31-41-162 etc]$


[ec2-user@ip-172-31-41-162 etc]$ sudo puppet agent --fingerprint
(SHA256) F8:4D:0C:8A:72:4E:B1:0D:A4:F1:E1:0D:C3:DF:ED:E1:E0:A3:50:04:07:8A:BD:F3:45:42:95:84:D4:14:62:3B
[ec2-user@ip-172-31-41-162 etc]$

[ec2-user@ip-172-31-41-162 etc]$ sudo puppet agent -t
Info: Retrieving plugin
Info: Caching catalog for puppetclient
Info: Applying configuration version '1514210434'
Notice: Finished catalog run in 0.01 seconds
[ec2-user@ip-172-31-41-162 etc]$

++++++++++ ALL DONE !!!!++++++++++++++++++
======================================================================================================

opening a PORT in master server:

iptables -I INPUT -m state --state NEW -m tcp -p tcp --dport 8140 -j ACCEPT

======================================================================================================

INSTALL JAVA AND TOMCAT USING PUPPET:

SERVER:
[ec2-user@ip-172-31-40-1 ~]$ sudo /bin/systemctl start puppetmaster.service
[ec2-user@ip-172-31-40-1 ~]$ ps -ef | grep puppet
root       991     1 66 18:38 ?        00:00:03 /usr/bin/ruby /usr/bin/puppet master --no-daemonize
ec2-user   994   959  0 18:39 pts/0    00:00:00 grep --color=auto puppet
[ec2-user@ip-172-31-40-1 ~]$
[ec2-user@ip-172-31-40-1 ~]$ ls /etc/puppet/m
manifests/ modules/
[ec2-user@ip-172-31-40-1 ~]$ ls /etc/puppet/manifests/
[ec2-user@ip-172-31-40-1 ~]$ ls -ltr /etc/puppet/manifests/
total 0
[ec2-user@ip-172-31-40-1 ~]$ vi /etc/puppet/manifests/site.pp

class { 'java':
        package => 'java-1.8.0-openjdk.x86_64',
}


[ec2-user@ip-172-31-40-1 ~]$ sudo puppet module install puppetlabs-java
Notice: Preparing to install into /etc/puppet/modules ...
Notice: Downloading from https://forgeapi.puppetlabs.com ...
Notice: Installing -- do not interrupt ...
/etc/puppet/modules
+-- puppetlabs-java (v2.3.0)
  +-- puppet-archive (v2.2.0)
  +-- puppetlabs-stdlib (v4.24.0)
[ec2-user@ip-172-31-40-1 ~]$


TO search a module:
sudo puppet module search puppetlabs-java
sudo puppet module search puppetlabs-tomcat

AGENT:

[ec2-user@ip-172-31-41-162 ~]$ sudo puppet agent -t
Info: Retrieving plugin
Info: Loading facts in /var/lib/puppet/lib/facter/java_version.rb
Info: Loading facts in /var/lib/puppet/lib/facter/puppet_settings.rb
Info: Loading facts in /var/lib/puppet/lib/facter/service_provider.rb
Info: Loading facts in /var/lib/puppet/lib/facter/java_default_home.rb
Info: Loading facts in /var/lib/puppet/lib/facter/java_libjvm_path.rb
Info: Loading facts in /var/lib/puppet/lib/facter/java_patch_level.rb
Info: Loading facts in /var/lib/puppet/lib/facter/facter_dot_d.rb
Info: Loading facts in /var/lib/puppet/lib/facter/root_home.rb
Info: Loading facts in /var/lib/puppet/lib/facter/package_provider.rb
Info: Loading facts in /var/lib/puppet/lib/facter/archive_windir.rb
Info: Loading facts in /var/lib/puppet/lib/facter/pe_version.rb
Info: Loading facts in /var/lib/puppet/lib/facter/java_major_version.rb
Error: Could not retrieve catalog from remote server: Error 400 on SERVER: Puppet::Parser::AST::Resource failed with error ArgumentError: Could not find declared class java at /etc/puppet/manifests/site.pp:3 on node puppetclient
Warning: Not using cache on failed catalog
Error: Could not retrieve catalog; skipping run
[ec2-user@ip-172-31-41-162 ~]$


Failed again after updating the exact java version in site.pp in PM-manifests

[ec2-user@ip-172-31-41-162 ~]$ sudo puppet agent -t
Info: Retrieving plugin
Info: Loading facts in /var/lib/puppet/lib/facter/java_version.rb
Info: Loading facts in /var/lib/puppet/lib/facter/puppet_settings.rb
Info: Loading facts in /var/lib/puppet/lib/facter/service_provider.rb
Info: Loading facts in /var/lib/puppet/lib/facter/java_default_home.rb
Info: Loading facts in /var/lib/puppet/lib/facter/java_libjvm_path.rb
Info: Loading facts in /var/lib/puppet/lib/facter/java_patch_level.rb
Info: Loading facts in /var/lib/puppet/lib/facter/facter_dot_d.rb
Info: Loading facts in /var/lib/puppet/lib/facter/root_home.rb
Info: Loading facts in /var/lib/puppet/lib/facter/package_provider.rb
Info: Loading facts in /var/lib/puppet/lib/facter/archive_windir.rb
Info: Loading facts in /var/lib/puppet/lib/facter/pe_version.rb
Info: Loading facts in /var/lib/puppet/lib/facter/java_major_version.rb
Error: Could not retrieve catalog from remote server: Error 400 on SERVER: Syntax error at 'String'; expected ')' at /etc/puppet/modules/java/manifests/init.pp:48 on node puppetclient
Warning: Not using cache on failed catalog
Error: Could not retrieve catalog; skipping run
[ec2-user@ip-172-31-41-162 ~]$

RCA:
"If you are getting syntax errors then you are probably still on puppet 3,
in which case you want the latest version of puppetlabs-java that still supports puppet 3 which is 1.6.0.
Puppet 3 reached EOL and support was dropped in the 2.0.0 release of this module."

SEREVER:

so uninstall the java
[ec2-user@ip-172-31-40-1 ~]$ sudo puppet module uninstall puppetlabs-java
Notice: Preparing to uninstall 'puppetlabs-java' ...
Removed 'puppetlabs-java' (v2.3.0) from /etc/puppet/modules

[ec2-user@ip-172-31-40-1 ~]$ sudo puppet module uninstall puppetlabs-archive
Notice: Preparing to uninstall 'puppetlabs-archive' ...
Error: Could not uninstall module 'puppetlabs-archive'
  Module 'puppetlabs-archive' is not installed
[ec2-user@ip-172-31-40-1 ~]$ sudo rm -rf /etc/puppet/modules/archive
[ec2-user@ip-172-31-40-1 ~]$ sudo rm -rf /etc/puppet/modules/stdlib

To manually install this module with puppet module tool:

puppet module install puppetlabs-java --version 2.3.0

AGENT:

[ec2-user@ip-172-31-41-162 ~]$ sudo puppet agent -t

Info: Loading facts in /var/lib/puppet/lib/facter/java_version.rb
Info: Loading facts in /var/lib/puppet/lib/facter/puppet_settings.rb
Info: Loading facts in /var/lib/puppet/lib/facter/service_provider.rb
Info: Loading facts in /var/lib/puppet/lib/facter/java_default_home.rb
Info: Loading facts in /var/lib/puppet/lib/facter/java_libjvm_path.rb
Info: Loading facts in /var/lib/puppet/lib/facter/java_patch_level.rb
Info: Loading facts in /var/lib/puppet/lib/facter/facter_dot_d.rb
Info: Loading facts in /var/lib/puppet/lib/facter/root_home.rb
Info: Loading facts in /var/lib/puppet/lib/facter/package_provider.rb
Info: Loading facts in /var/lib/puppet/lib/facter/pe_version.rb
Info: Loading facts in /var/lib/puppet/lib/facter/java_major_version.rb
Info: Caching catalog for puppetclient
Warning: The package type's allow_virtual parameter will be changing its default value from false to true in a future release. If you do not want to allow virtual packages, please explicitly set allow_virtual to false.
   (at /usr/share/ruby/vendor_ruby/puppet/type.rb:816:in `set_default')
Info: Applying configuration version '1514230692'
Notice: /Stage[main]/Java/Package[java]/ensure: created
Notice: Finished catalog run in 14.31 seconds
[ec2-user@ip-172-31-41-162 ~]$

[ec2-user@ip-172-31-41-162 ~]$ java -version
openjdk version "1.8.0_151"
OpenJDK Runtime Environment (build 1.8.0_151-b12)
OpenJDK 64-Bit Server VM (build 25.151-b12, mixed mode)
[ec2-user@ip-172-31-41-162 ~]$


SERVER:

TOMCAT INSTALLATION ON PM

[ec2-user@ip-172-31-40-1 ~]$ sudo puppet module install puppetlabs-tomcat
Notice: Preparing to install into /etc/puppet/modules ...
Notice: Downloading from https://forgeapi.puppetlabs.com ...
Notice: Installing -- do not interrupt ...
/etc/puppet/modules
+-- puppetlabs-tomcat (v2.1.0)
  +-- puppet-archive (v1.3.0)
  +-- puppetlabs-concat (v4.1.1)
  +-- puppetlabs-stdlib (v4.24.0)

[ec2-user@ip-172-31-40-1 ~]$ vi /etc/puppet/manifests/site.pp

tomcat::install { '/app/platform/tomcat/':
        source_url => 'http://archive.apache.org/dist/tomcat/tomcat-8/v8.5.0/bin/apache-tomcat-8.5.0.tar.gz',
}
tomcat::instance { 'default':
        catalina_home => '/app/platform/tomcat/',
}

tomcat server version issue so need to downgrade the tomcat version from the puppetlabs-tomcat


[ec2-user@ip-172-31-40-1 ~]$ sudo puppet module uninstall puppetlabs-tomcat
Notice: Preparing to uninstall 'puppetlabs-tomcat' ...
Removed 'puppetlabs-tomcat' (v2.1.0) from /etc/puppet/modules
[ec2-user@ip-172-31-40-1 ~]$ sudo puppet module uninstall puppetlabs-concat
Notice: Preparing to uninstall 'puppetlabs-concat' ...
Removed 'puppetlabs-concat' (v4.1.1) from /etc/puppet/modules
[ec2-user@ip-172-31-40-1 ~]$


lower version of tomcat:

[ec2-user@ip-172-31-40-1 ~]$ sudo puppet module install puppetlabs-tomcat --version 1.2.0
Notice: Preparing to install into /etc/puppet/modules ...
Notice: Downloading from https://forgeapi.puppetlabs.com ...
Notice: Installing -- do not interrupt ...
/etc/puppet/modules
+-- puppetlabs-tomcat (v1.2.0)
  +-- nanliu-staging (v1.0.3)
  +-- puppetlabs-concat (v4.1.1)
  +-- puppetlabs-stdlib (v4.24.0)
[ec2-user@ip-172-31-40-1 ~]$


[ec2-user@ip-172-31-40-1 ~]$ sudo puppet module install --gnore-dependencies puppetlabs-tomcat --version 1.3.0
Error: Could not parse application options: invalid option: --gnore-dependencies
[ec2-user@ip-172-31-40-1 ~]$
[ec2-user@ip-172-31-40-1 ~]$
[ec2-user@ip-172-31-40-1 ~]$ sudo puppet module install --ignore-dependencies puppetlabs-tomcat --version 1.3.0
Notice: Preparing to install into /etc/puppet/modules ...
Notice: Downloading from https://forgeapi.puppetlabs.com ...
Notice: Installing -- do not interrupt ...
/etc/puppet/modules
+-- puppetlabs-tomcat (v1.3.0)
[ec2-user@ip-172-31-40-1 ~]$


++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
AFTER INSTALLING 2 CENTOS:
AGENT:
[root@CentOs-Agent abinash]# /etc/init.d/puppet start
Starting puppet agent:                                     [  OK  ]
[root@CentOs-Agent abinash]#

ISSUE:

[root@CentOs-Agent abinash]# puppet agent -t
Error: Could not request certificate: No route to host - connect(2)
Exiting; failed to retrieve certificate and waitforcert is disabled

FIX:
[root@CentOS-Master abinash]# iptables -F
[root@CentOS-Master abinash]# service iptables save
iptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ]
[root@CentOS-Master abinash]#

WORKING:	
[root@CentOs-Agent abinash]# telnet puppetmaster 8140
Trying 192.168.0.29...
telnet: connect to address 192.168.0.29: No route to host
[root@CentOs-Agent abinash]#
[root@CentOs-Agent abinash]#
[root@CentOs-Agent abinash]# telnet puppetmaster 8140
Trying 192.168.0.29...
Connected to puppetmaster.
Escape character is '^]'.
^C^ZConnection closed by foreign host.
[root@CentOs-Agent abinash]#


CERTIFICATE SIGN ON AGENT:
[root@CentOs-Agent abinash]# puppet agent -t
Exiting; no certificate found and waitforcert is disabled
[root@CentOs-Agent abinash]#

CERTIFICATE SIGN ON MASTER:
[root@CentOS-Master abinash]#
[root@CentOS-Master abinash]# puppet cert list
  "centos-agent" (SHA256) 2F:70:55:17:72:6F:7E:E9:EA:B5:4A:9B:09:AC:63:CD:3A:B2:A2:B5:44:FB:C9:9B:73:2E:8E:03:C9:20:37:11
[root@CentOS-Master abinash]# puppet cert sign centos-agent
Notice: Signed certificate request for centos-agent
Notice: Removing file Puppet::SSL::CertificateRequest centos-agent at '/var/lib/puppet/ssl/ca/requests/centos-agent.pem'
[root@CentOS-Master abinash]#
